---
title: "[聊聊架构]软件架构——如何写好代码"
author: "wukn"
tags: ["Architecture"]
catalog: true
date: 2018-05-16T23:00:00+08:00
url: /2018/05/11/architecutre-talks-write-good-code/

---

> 代码是最容易写的，因为随便怎么写，只要符合语法就能够运行起来。代码也是最难写的，要想让代码容易维护，还要和业务一起长大，使得软件架构容易随着业务的长大做出新的拆分、合并，并要保证准确性。同时达到这么多要求是非常困难的。

<!--more-->

软件生命周期中有两个最重要的子生命周期，软件开发生命周期和软件运行生命周期。其中，软件运行生命周期是核心生命周期，软件开发生命周期是为软件运行生命周期服务的，所以软件开发时必须要考虑到软件运行生命周期的特质，这一特质也决定了代码应该如何组织和编写。

软件实际上是对现实业务的模拟、虚拟化。结合软件的运行生命周期可以看出软件主要是完成对业务生命周期的模拟，在此基础上完成用户的访问生命周期，使得用户能够达到模拟的业务生命周期。因此，代码由两部分组成：

（1）表达业务生命周期的代码。通常叫做业务逻辑（Domain Logic）或业务模型（Domain Model）。这部分是来源于生活与业务，必须和现实生活及业务保持一致。也就是说，业务代码的拆分要和现实生活中业务人员的职责拆分一致，并保持内聚。内聚是指某个生命周期的变化是累积在一个生命周期主体上，而不是分散在不同的主体上。在代码中表示一个生命周期主体，就是指一个对象，对象的名字就是生命周期主体的名字，对象的方法就是该生命周期主体的活动，对象内部的数据就是该生命周期主体执行活动的结果，累积在该对象上。某一时刻对象的内部数据就是该生命周期主体当前的状态。对象的内部数据随着生命周期活动的进行以及时间而发生变化。对象内部数据的变化，既记录着业务的变化，也记录这生命周期活动的推进。

（2）表达用户访问生命周期的代码。软件的核心生命周期就是为用户提供对业务的访问，使得业务逻辑能够服务于用户。而为了让用户能够访问到所模拟的业务逻辑，则必须要提供访问的通道。表达访问生命周期的代码就是业务生命周期对外的访问通道，软件的核心价值通过这部分代码展现出来。

软件的代码可以分为三部分，服务、业务和存储。业务部分实现业务的逻辑，实现对业务生命周期的模拟。业务的状态要靠存储来持久化。服务则相当于通道，提供用户对业务的访问。通道的意思是只负责调用业务逻辑，但不包含业务逻辑。服务为完成用户访问生命周期，承担的责任包括组合业务和存储，还要提供给用户访问。而用户访问业务逻辑生命周期可以展开为：

* 服务首先把业务的状态从存储中加载。这个生命周期的主体为业务状态获取。

* 服务调用并组合业务逻辑完成业务的访问。这个生命周期的主体为业务访问。这个生命周期也是业务访问生命周期的核心生命周期。

* 服务把业务逻辑执行后的状态保存到存储中。这个生命周期的主体为业务状态保存。

### 什么叫业务逻辑

可以看出，业务中的代码是最重要的。因为真正干活的是业务代码。业务逻辑以业务核心生命周期为主线，切分出一个树状架构。树上的每个节点都有其独有的生命周期，每个节点都有一个独立的概念来表达这个生命周期的特质。切分出来的生命周期是否完整。

什么叫内聚？内聚就是要确保一个事物的生命周期是完整的，而不是分裂的。所谓完整，就是指一个生命周期的主体，从生到死之间的整个过程中，所发生的行为和状态是累积在一个主体上的。

### 业务逻辑分散的危害

如果业务逻辑不是内聚的就是散落到很多其他地方去，如散落到服务代码或存储代码中。如果服务中混入了业务逻辑，则服务做了两件或两件以上的事情。服务本身的责任是访问逻辑，这是顺序执行。加入了业务逻辑就表明做了两件或两件以上的事情。典型的情况就是两个不同的访问生命周期合并在一个服务中来实现。还有一种情况就是有计算的逻辑放在了服务代码中，这个就会不便于单元测试。同样，存储代码中混入业务逻辑的话也很容易出问题，例如写出很复杂的SQL语句，还会造成数据库无法水平扩展，只能换性能更好的机器纵向扩展。

### 业务逻辑内聚的好处

服务和存储里面的代码都是严格的访问代码，而访问代码的特征就是简单的顺序调用，因此这些代码只要做连通性测试即可，不需要单元测试。这是真正的组合。如果访问代码需要做单元测试的话，就需要使用Mock技术把上下文模拟出来（服务器相关的、存储、缓存、网络相关上下文），才能获取到数据并执行代码。

由于业务不访问任何计算机设备相关的上下文，因此是非常容易写单元测试的，而且单元测试必须保证100%覆盖。

服务代码和存储代码简单了，开发人员就能把更多的时间投入到业务中。毕竟业务才是软件的核心。

### 业务模型、数据实体与DTO

业务模型关心的是其生命周期，数据是这些生命周期行为的状态。所以存储时业务模型要转换为存储设备的实体，实体和存储设备里面的存储粒度一一对应。比如数据库中每个实体对应一张表，且跟着表的变化而变化。同样，业务模型不能拿来用作服务和用户之间的数据交互媒介，只能转换为DTO来使用。也就是说业务模型对用户是不可见的。DTO的目的是在用户的访问操作中传输数据，并和用户交互的视图保持一致。通过增加DTO可以保证用户的访问生命周期需求变化不会影响到业务模型。

### 软件的拆分

随着业务逐渐长大，业务部门会发生架构拆分，同样软件也需要拆分了。例如订单、用户、账户、商品这几个业务生命周期，在开始的时候可以放在一个软件中实现，通过服务暴露出去，对外界提供服务。随着用户、账户和商品的增长。这几个业务可能会拆分成不同的部门负责，同时软件的运行效率也成了问题。这时候就需要对软件进行拆分。

软件的拆分必须要和业务的拆分对应起来。这种拆分当时形成了新的软件。对原软件的影响仅仅是对被拆分出去的业务调用方式发生了变化而已，从本地调用变成了服务调用。

---

参考资料：

《聊聊架构》——王概凯
