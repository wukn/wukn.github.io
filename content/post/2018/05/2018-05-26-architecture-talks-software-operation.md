---
title: "[精耕]软件架构——软件运维"
author: "wukn"
tags: ["Architecture"]
catalog: true
date: 2018-05-26T22:00:00+08:00
url: /2018/05/26/architecutre-talks-software-operation/

---

> 软件生命周期在拆分后，相对于软件运行生命周期，软件的开发生命周期实际上变成了非核心生命周期，只是为了生产软件而服务。而软件的运行生命周期才是真正的软件核心生命周期。运维才是软件真正的核心竞争力。

<!--more-->

### 软件运行生命周期

软件的运行生命周期从软件启动开始，不断地运行，积累数据，直到软件被终止运行。在软件的整个生命周期中，会经历多次的软件运行生命周期。而软件的运行生命周期所要达到的主要目的，则是为了能够提供给用户持续不断的访问，因为软件运行生命周期的核心是软件访问生命周期。

在软件的运行生命周期中，会经历多次的软件访问生命周期。软件的访问生命周期，从软件接收到用户的访问请求开始，执行用户的请求，到返回给用户请求结果为止。

### 什么是软件运维

软件运维其实就是指软件的运行和维护。软件的启动、停止、版本更新等运行生命周期活动，由运维工程师来进行维护。为了维护好软件运行生命周期，运维工程师需要安置相应的传感器来搜集软件生命活动的健康状况。比如软件是否存活？用户的访问生命周期是否正常？这些运维监控软件需要由软件工程师进行开发，形成了一个独立的业务领域。运维监控的生命周期从软件的运行生命周期中拆分出来。

运维工程师本质上也是一个软件工程师，只不过专注的领域是计算机软件本身的运营和维护，与软件工程师所针对的业务领域不同罢了。一旦运维软件变得成熟，软件工程师就可以代替软件运维工程师的工作，这个角色就可以回归到业务的软件工程师。

### 运维的业务模型

运维的工作被拆分出来后，形成了一个新的业务领域。运维的业务目标是保证用户的访问生命周期不受影响。也就是保证软件稳定地被用户访问。而保持软件的运行稳定，就要求运维能够感知软件的运行状态，能够探测软件的状态是否超出边界，并对之进行处理，使软件尽快恢复正常。

软件运行在硬件上，硬件又依赖电力和网络。软件、硬件、电力和网络任何一个变化，都会影响软件的稳定运行。同时，软件是提供给用户使用的，用户访问量的变化也会导致软件的不稳定。如何控制这些变化，以及监控这些变化就成了运维的主要业务。必须先知道变化才能够对变化采取行之有效的行动。

### 控制变化

运维的生命周期是从软件部署开始的。任何对软件的改变，都是风险，都是需要运维关注的。因此，每次变化的风险控制是最重要的任务。

#### 隔离

要做好变化的控制，首先要做的是：在软件周围设立隔离区，避免软件出现在不安全的地方。通过隔离区可以控制所有对软件的改变，对软件所依赖的硬件、网络和电力也是同样的，只有设立隔离区才能保证软件的安全。

为了控制变化，隔离环境是第一件要做的事情。

#### 如何隔离

如何做好隔离呢？首先要拆分软件的运行环境。根据软件的生命周期，首先要区分出开发环境和生产环境。开发环境是软件工程师编写代码、
测试代码的环境。生产环境是给用户访问的、是企业提供用户的服务。

生产环境需要有独立的机房、独立的电源、独立的网络等等。从其他环境来访问生产环境都必须是受控的。

#### 控制变更

什么是变更？生产环境一旦建立，那么生产环境就有了自己的生命周期，其内部就会开始持续不断地发生生命周期变化，这些生命周期变化就是变更。生产环境的变更分两类：一种是被动发生的变更，一种是企业内部主动发起的变更。

被动发生的变更有：机器的硬盘损坏，用户访问量突然猛增，等等。被动发生的变更往往是无法预测的。要控制这一类的变更对软件的影响，运维就必须容忍这些变更的发生。例如通过购买稳定的产品，定期淘汰设备来避免问题的发生，还有通过设备冗余提高可靠性。即使如此，还是会有一定的概率出现某些变更导致软件系统的运行受影响。针对这类情况，唯一的办法只能是快速发现问题并解决问题，减少问题对用户的影响时长。

企业内部主动发起的变更往往是导致软件系统出问题的主要原因。主动变更分为软件的变更、硬件的变更、网络的变更和电力的变更。据统计，主动变更所导致的软件系统问题约占线上问题的2/3以上。其中软件本身的变更所造成的问题约占所有线上问题的一半以上，占主动变更的绝大部分。

要控制这些主动变更，就必须确保这些变更在指定的地点和执行的时间发生，并让所有运维人员都知情。这也是为什么要隔离出生产环境。未隔离的环境任何人都可以在任何时候做变更，令人防不胜防。

### 监控变更

生产环境的线上问题无法避免，也无法完全消灭，因此必须要拥抱变更才行。而拥抱变更的底气则来源于运维对系统的自信，以及对系统运行状态的了解程度。既然线上问题无法完全避免，唯一的办法就是减少问题产生后带来的损失。要么提前预防问题，要么缩短问题影响的时间，两者都要具备快速发现并定位问题的能力。这个能力来自于时刻地感知系统的运行状态，也就是监控。

监控的目的实际上就是把系统内不同生命周期的当前运行状态，通过探测器传输出来，展示到可视或可感知的设备上，来供人查看。监控非常重要的指标就是实时度。

### 预警变更

监控的主要目的是实时收集数据并展示出来。但是当数据很多的时候，人就无法判断哪些数据是有问题的，哪些是正常的数据。这就药人们去理解数据，而理解数据的前提是理解不同生命周期主体本身的业务。

监控一台计算机，就需要理解计算机的生命周期。从上电到下电，它的生命周期变化的活动情况如何？有哪些指标能说明这台机器是正常的？在什么范围是不正常的？监控一个软件也是一样的，得知道软件的生命周期是怎样的，它对应的业务生命周期是怎样的，什么指标说明业务是正常运作的。

理解了这些数据和指标，监控人员就可以对超出正常范围的数据进行报警，马上采取行动，尽可能在问题造成实际损害之前把问题解决掉。这就是运维的预警。预警的内容往往包含两部分：一部分是软件本身业务的预警，主要包括软件、硬件、网络、电力等设备；另一部分是软件所实现业务的预警，例如用户注册量、订单量等等。

生成预警的主要困难在于对业务生命周期的理解。一旦理解了业务生命周期就会发现，业务的数据会周期性的变化，这就意味着可以用历史的数据作为报警的基线。

监控是生成预警的数据基础。对业务生命周期的理解则是生成预警的规则基础。

预警发出来之后，预警本省的生命周期也需要管理。从生成到撤销，该预警是否得到了及时处理？是否误报？预警级别是否需要调整？对整个运维来说，预警软件是整个运维工作的核心。

### 主导变更

做任何一个变更，运维都需要知道变更对系统的影响如何，如果监控到的数据和预料的一样，其他的系统也没有产生预警，那么这个变更就是正常的。如果变更有问题，可以通过监控和预警发现，快速回退变更，消除变更带来的影响。

对于被动的变更，有了监控和预警，也可以快速地发现，缩短对被动变更的响应时间，快速地恢复。

要主导变更，首要任务就是跟踪变更。这就需要理解变更的生命周期。变更从创建开始到实施结束为一个生命周期。通过跟踪变更，就可以知道变更发生的时间顺序，帮助快速地定位问题。通过对一段时间内变更的规律进行分析，还可以帮助优化变更，减少不必要的变更，降低变更的频度。变更本身也是一个独立的业务，也是需要监控和预警的。

#### 发布

变更在生产环境的执行一般称之为发布，对变更进行管理的系统叫做发布系统。

主导变更的策略就是要让变更逐步地发生，一般称作“灰度发布”，核心思想就是尽可能减少变更所影响的范围。先在少量机器上应用变更，监控和预警都正常再逐渐发布到其他机器上。

一般第一次发布风险最大，因此一般选可发布的最小单位，如一台机器。对于特别重要的软件，往往在发布50%之后，经历一次业务高峰后再发布剩余的机器。因为即使该变更有问题，还有剩下的50%的机器能够支撑业务运作。这意味着在建立集群的时候需要有50%的冗余容量做缓冲。

灰度发布对软件是有要求的，软件本身能够支持两个不同版本的代码同时运行在线上，且对用户是透明的。为了能够回退变更，对数据库的操作要非常谨慎，必须确保数据库的变更是可以通过回退恢复的。这意味着数据库的变更不唔唔修改旧有的数据，只能增加新的数据。否则往往需要停机维护。

更先进的一个做法是，把代码的发布和功能启用进行架构拆分，先确保代码上线没有问题，再通过软件开关来打开关闭某个功能。

### 提升变更质量

直接从开发环境向生产环境发布的风险是很高的。因此往往会架设一个跟生产环境一样架构的测试环境，该环境和测试环境的主要区别是集群所包含的机器数量不同，因为这个环境流量很低，不需要那么多机器。这个环境一般成为回归测试环境或Staging环境。

回归的重点就是测试新旧功能是否能够正常地执行。回归测试一般用自动化来完成，因为大部分测试都是原有的功能。

生产环境只有一个，对应的回归测试环境也只能有一个。回归的极限是生产环境，要在这个基线上对新功能进行测试。但是开发可能有多个版本并发进行，因此会有多个软件同时等待回归测试这就形成了回归测试环境争抢的问题。为此，需要一回归测试环境为基线，建立多个功能测试环境，主要用来测试不同软件新增的功能。

同样软件工程师开发时也需要测试环境来测试心功能的。为了解决软件工程师和此时人员对功能测试环境相冲突的问题，开需要建立一个开发测试环境，专门给开发人员使用。

这就形成了流水线：开发测试环境——功能测试环境——回归测试环境——生产环境。

另一个影响变更质量的因素是手工操作。解决这类问题的唯一办法就是把发布变更的操作自动化，并且让发布的动作在测试环境测试通过没有问题之后，才能在生产环境发布。这样才能避免人工的低级错误。

---

参考资料：

《聊聊架构》——王概凯
