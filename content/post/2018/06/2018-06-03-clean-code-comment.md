---
title: "[精耕]代码整洁之道——注释"
author: "wukn"
tags: ["Code"]
catalog: true
date: 2018-06-03T00:00:00+08:00
url: /2018/06/03/clean-code-comment/

---

> 什么也比不上放置良好的注释来得有用。什么也不会比乱七八糟的注释更有本事搞乱一个模块。什么也不会比陈旧、提出错误信息的注释更有破坏性。若变成语言足够有表达力，或者我们长于用这些语言来表达意图，就不那么需要注释了。

<!--more-->

注释的恰当用法是弥补我们在代码表达意图时遭遇的失败。注意**失败**一词。注释总是一种失败，我们总无法找到不用注释就能表达自我的方法，所以总要有注释。如果发现需要写注释，那就要再想想看有没有办法翻盘，用代码来表达。

为何如此贬低注释？因为注释会撒谎。注释存在的时间越久，就离其所描述的代码越远，越来越变得全然错误。原因很简单，程序员不能坚持维护注释。代码在变动，在演化，在不断地重构。注释并不总是随之变动。注释常常会与其所描述的代码分隔开来，孑然飘零，越来越不准确。

程序员应当负责将注释保持在可维护、有关联、精确的高度。但更重要的是把力气用在写清楚的代码上，直接保证无须编写注释。

不准确的注释要比没有注释坏的多。它们满口胡言。真实只存在于代码中。只有代码能忠实地告诉读者它做的事。那是唯一真正准确的信息来源。所以，尽管有时也需要注释，我们也该多花心思尽量减少注释量。

### 注释不能美化糟糕的代码

写注释的常见动机之一是糟糕的代码的存在。带有少量注释的整洁而有表达力的代码，要比带有大量注释的零碎而复杂的代码好的多。与其花时间编写解释这糟糕代码的注释，不如花时间清洁那堆糟糕的代码。

### 用代码来阐述

有时，代码本身不足以解释其行为。不幸的是，许多程序员据此以为代码很少——如果有的话——能做好解释工作。这种观点纯属错误。比较一下这两段代码：

```java
//Check to see if the employee is eligible for full benefits
if ( (employee.flags & HOURLY_FLAG) && (employee.age > 65))
```

```java
if (employee.isEligibleForFullBenefits())
```

只要想上那个几秒钟，就能用代码解释大部分的意图。很多时候，简单到只需要创建一个描述与注释所言同一事物的函数即可。


### 好注释

有些注释是必须的，也是有利的。

* **法律信息**：有时，公司代码规范要求编写与法律有关的注释。例如，版权及著作权声明就是必须和有理由在每个源文件开头注释处放置的内容。这类注释不应是合同或法典。只要有可能，就指向一份标准许可或其他外部文档，而不是要把所有条款放到注释中。

* **提供信息的注释**：不可否认，有时候用注释来提供基本信息也有其用处。

* **对意图的解释**：有时，注释不仅提供了有关实现的有用信息，而且还提供了某个决定后面的意图。

* **阐释**：有时，注释把某些晦涩难明的参数或返回者的意义翻译为某种可读形式，也会是有用的。通常更好的办法是尽量让参数或返回值自身就足够清楚，但如果参数或返回值是某个标准库的一部分，或是你不能修改的代码，帮助阐释其含义的注释就会有用。但这也会冒着注释本身就不正确的风险。
* **警示**：有时，用于警告其他程序员会出现某种后果的注释也是有用的。例如“//SimpleDateFormat is not thread safe, so we need to create each instance independently.”，它能阻止某些急切的程序员以效率之名使用静态初始器。

* **TODO注释**：有时，有理由用//TODO形式在源代码中放置要做的工作列表。TODO是一种程序员认为应该做，但由于某些原因目前还没做的工作。

* **放大**：注释可以用来放大某种看来不合理之物的重要性。

* **公共API中的Javadoc**：没有什么比被良好描述的公共API更有用和令人满意了。如果在编写API，就该为它编写良好的Javadoc。不过要考虑也其他建议。就像其他注释一样，Javadoc也可能误导、不适用或者提供错误信息。

### 坏注释

大多数注释都属此类。通常，坏注释都是糟糕的代码的支撑或借口，或者对错误决策的修正，基本上等于程序员自说自话。

* **喃喃自语**：如果决定写注释，就要花必要的时间确保写出最好的注释。

* **多余的注释**：有的函数已足够短小简单，读其注释花的时间可能比读代码花的时间还长。有的注释不能比代码提供更多的信息。事实上，它不如代码精确，误导读者接受不精确的信息，而不是正确地理解代码。

* **误导性注释**：有时，尽管初衷可嘉，程序员还是会写出不够精确的注释。注释描述的与代码本身存在细微差异，这会误导其他程序员对其的调用，达不到期望的结果。

* **循规式注释**：所谓每个函数都要有Javadoc或每个变量都要有注释的规矩是愚蠢可笑的。例如构造函数和get/set函数为何要有Javadoc描述呢？

* **日志式注释**：在没有源代码管理系统的年代，在每个模块开始处维护修改日志还算有道理。如今，这种冗长的记录只会让模块变得凌乱不堪，应当全部删除。

* **废话注释**：如`/** The day of the month. */ private int dayOfMonth;`，这类注释废话连篇，我们都学会了视而不见。最终，当代码修改之后，这类注释就变做了谎言一堆。Javadoc也可能是废话。

* **能用函数或变量时就别用注释**：使用函数名或变量名来表明意图是最好的。

* **括号后面的注释**：有的程序员会在while/try/catch等右大括号后面添加如“//while”或“//try”、"//catch"这类的注释。这对于深度嵌套结构的长函数有意义，但实际上应该做的是缩短函数。

* **归属与署名**：源代码管理系统善于记住谁在何时添加了什么。没有必要在代码中用那些签名来搞脏代码。也许你认为这种注释大概有助于他人了解该和谁讨论这段代码。然而事实是，注释在那放了一年又一年，越来越不准确，越来越和原作者没有关系。

* **注释掉的代码**：直接把代码注释掉是很令人讨厌的做法。其他人不敢删除，他们对象，代码依然放在那儿，一定有其原因，而且这段代码很重要，不能删除。现在我们都是用源代码管理系统，无门无需使用注释来标记那些不要的代码，删掉即可。

* **HTML注释**：源代码注释中的HTML注释也是令人讨厌的。本来代码是易于阅读的，却因为HTML注释的存在而变得难以卒读。如果注释将由某种工具（如Javadoc）抽取出来，呈现到网页，那么该是工具而非程序员来负责给注释加上何时的HTML标签。

* **非本地信息**：假如要写注释，请确保它描述了离它最近的代码。

* **信息过多**：别在注释中添加有趣的历史性话题或者无关细节的描述。“有一天，Alice和Bob讨论到关于xx的实现，...最终选择这种实现方式。”

* **不明显的联系**：注释及其代码之间的联系应该显而易见。如果要不嫌麻烦写注释，至少让读者看着注释和代码，能理解注释所谈何物。

* **非公共代码中的Javadoc**：虽然Javadoc对于生成公共API非常有用，但对于不打算作公共用途的代码就令人厌恶了。

---

参考资料：

《代码整洁之道》——Robert C. Martin
